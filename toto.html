<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
</head>

<body>
<div id="wholeChart">
  <h3 id="chartTitle">Le "jour de dépassement" depuis 1970</h3>
  <div id="chart"></div>
  <h5>Nombre de jours dans l'année : <span id="pieTotal"></span></h5>
  <div id="yearSelection">
    <strong>Année</strong>: <span id="sliderVal">0</span><br>
    <span id="startYear"></span>
    <input id="dataYear" type="range" min="1970" max="2018" step="1" value="1970" onchange="sliderValChange(this.value)" />
    <span id="endYear"></span><br>
    <button onclick="reset()" class="btn btn-success">Réinitialiser</button>
    <button onclick="autoPlay()" class="btn btn-primary">Lancer l'animation</button>
  </div>
</div>
</body>
</html>

<script>
var labels = ["Jours à crédit ", "Jours avant le dépassement "];
var dataVals = {
1970: [3,362],
1971: [10,355],
1972: [15,351],
1973: [26,339],
1974: [25,340],
1975: [23,342],
1976: [34,332],
1977: [37,328],
1978: [39,326],
1979: [46,319],
1980: [43,323],
1981: [37,328],
1982: [35,330],
1983: [35,330],
1984: [40,326],
1985: [42,323],
1986: [45,320],
1987: [50,315],
1988: [55,311],
1989: [57,308],
1990: [58,307],
1991: [59,306],
1992: [58,308],
1993: [58,307],
1994: [59,306],
1995: [62,303],
1996: [65,301],
1997: [67,298],
1998: [67,298],
1999: [67,298],
2000: [70,296],
2001: [71,294],
2002: [74,291],
2003: [82,283],
2004: [88,278],
2005: [91,274],
2006: [95,270],
2007: [100,265],
2008: [99,267],
2009: [97,268],
2010: [105,260],
2011: [107,258],
2012: [106,260],
2013: [107,258],
2014: [107,258],
2015: [106,259],
2016: [106,260],
2017: [107,258],
2018: [109,256],
};

var currency = ""; // Appended to beginning of label values
var startYear = 1970;
var endYear = 2018;

var transitionTime = 250; // ms per transition
</script>

<!-- // ======||||| You shouldn't need to change anything below this line ||||||========= -->

<style>
#wholeChart {
  text-align:center;
  position: relative;
  font-family: 'Roboto';
}

#chart {
  display:inline-block;
  width:100%;
  height:500px;
  margin:10px;
}

#dataYear {
  max-width:200px;
  display:inline;
  margin-left:auto;
  margin-right:auto;
}
svg{
  width: 100%;
  height: 100%;
  font-family: 'Roboto';
}
path.slice{
  stroke-width:2px;
}

polyline{
  opacity: .3;
  stroke: black;
  stroke-width: 2px;
  fill: none;
}
</style>

<script src="https://d3js.org/d3.v3.min.js"></script>

<script> function initializeChart() {
    sliderValChange(document.getElementById("dataYear").value), document.getElementById("dataYear").setAttribute("min", startYear), document.getElementById("dataYear").setAttribute("max", endYear), document.getElementById("startYear").innerHTML = startYear, document.getElementById("endYear").innerHTML = endYear
}

function sliderValChange(e) {
    document.getElementById("sliderVal").innerHTML = e;
    var t = dataVals[e].reduce(function(e, t) {
        return e + t
    }, 0);
    document.getElementById("pieTotal").innerHTML = currency + t.toString(), change(getData(e))
}

function getCurrentYear() {
    return document.getElementById("dataYear").value
}

function getData(e) {
    return yearData(e)
}

function yearData(e) {
    for (var t = color.domain(), a = [], r = dataVals[e], n = Math.min(t.length, r.length), l = 0; n > l; l++) {
        var i = {
            label: t[l],
            value: r[l]
        };
        a.push(i)
    }
    return a
}

function reset() {
    document.getElementById("dataYear").value = startYear, sliderValChange(document.getElementById("dataYear").value)
}

function autoPlay() {
    getCurrentYear() != endYear && (document.getElementById("dataYear").value++, sliderValChange(document.getElementById("dataYear").value), setTimeout(function() {
        autoPlay()
    }, 250))
}

function mergeWithFirstEqualZero(e, t) {
    var a = d3.set();
    t.forEach(function(e) {
        a.add(e.label)
    });
    var r = e.filter(function(e) {
        return !a.has(e.label)
    }).map(function(e) {
        return {
            label: e.label,
            value: 0
        }
    });
    return d3.merge([t, r]).sort(function(e, t) {
        return d3.ascending(e.label, t.label)
    })
}

function change(e) {
    function t(e) {
        return e.startAngle + (e.endAngle - e.startAngle) / 2
    }
    var a = transitionTime,
        r = svg.select(".slices").selectAll("path.slice").data().map(function(e) {
            return e.data
        });
    0 === r.length && (r = e);
    var n = mergeWithFirstEqualZero(e, r),
        l = mergeWithFirstEqualZero(r, e),
        i = svg.select(".slices").selectAll("path.slice").data(pie(n), key);
    i.enter().insert("path").attr("class", "slice").style("fill", function(e) {
        return color(e.data.label)
    }).each(function(e) {
        this._current = e
    }), i = svg.select(".slices").selectAll("path.slice").data(pie(l), key), i.transition().duration(a).attrTween("d", function(e) {
        var t = d3.interpolate(this._current, e),
            a = this;
        return function(e) {
            return a._current = t(e), arc(a._current)
        }
    }), i = svg.select(".slices").selectAll("path.slice").data(pie(e), key), i.exit().transition().delay(a).duration(0).remove();
    var s = svg.select(".labels").selectAll("text").data(pie(n), key);
    s.enter().append("text").attr("dy", ".35em").style("opacity", 0).text(function(e) {
        return e.data.label
    }).each(function(e) {
        this._current = e
    }), s = svg.select(".labels").selectAll("text").data(pie(l), key).text(function(e) {
        return e.data.label + ": " + currency + e.data.value
    }), svg.select(".centerYear").text(getCurrentYear()), s.transition().duration(a).style("opacity", function(e) {
        return 0 === e.data.value ? 0 : 1
    }).attrTween("transform", function(e) {
        var a = d3.interpolate(this._current, e),
            r = this;
        return function(e) {
            var n = a(e);
            r._current = n;
            var l = outerArc.centroid(n);
            return l[0] = radius * (t(n) < Math.PI ? 1 : -1), "translate(" + l + ")"
        }
    }).styleTween("text-anchor", function(e) {
        var a = d3.interpolate(this._current, e);
        return function(e) {
            var r = a(e);
            return t(r) < Math.PI ? "start" : "end"
        }
    }), s = svg.select(".labels").selectAll("text").data(pie(e), key), s.exit().transition().delay(a).remove();
    var u = svg.select(".lines").selectAll("polyline").data(pie(n), key);
    u.enter().append("polyline").style("opacity", 0).each(function(e) {
        this._current = e
    }), u = svg.select(".lines").selectAll("polyline").data(pie(l), key), u.transition().duration(a).style("opacity", function(e) {
        return 0 === e.data.value ? 0 : .5
    }).attrTween("points", function(e) {
        this._current = this._current;
        var a = d3.interpolate(this._current, e),
            r = this;
        return function(e) {
            var n = a(e);
            r._current = n;
            var l = outerArc.centroid(n);
            return l[0] = .95 * radius * (t(n) < Math.PI ? 1 : -1), [arc.centroid(n), outerArc.centroid(n), l]
        }
    }), u = svg.select(".lines").selectAll("polyline").data(pie(e), key), u.exit().transition().delay(a).remove()
}
var color = d3.scale.category20().domain(labels).range(["#eb501e", "#f58c3c"]),
    svg = d3.select("#chart").append("svg").append("g");
    svg.append("g").attr("class", "slices"), svg.append("g").attr("class", "labels"), svg.append("g").attr("class", "lines"), svg.append("text").attr("text-anchor", "middle").text(getCurrentYear()).style({
    "font-size": "25px"
}).classed("centerYear", !0);
var width = document.getElementById("chart").offsetWidth,
    height = document.getElementById("chart").offsetHeight;
radius = Math.min(width - 300, height) / 2;
var pie = d3.layout.pie().sort(null).value(function(e) {
        return e.value
    }),
    arc = d3.svg.arc().outerRadius(.8 * radius).innerRadius(.4 * radius),
    outerArc = d3.svg.arc().innerRadius(.9 * radius).outerRadius(.9 * radius);
svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
var key = function(e) {
    return e.data.label
};
initializeChart(); </script>